<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>我的學術資料查詢 - 國家教育研究院學術典藏系統</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/tailwind.min.css">
    <link rel="stylesheet" href="./css/main.min.css">
    <link rel="stylesheet" href="./css/style.min.css">
    <link rel="stylesheet" href="./css/bootstrap-icons.css">
    <link rel="stylesheet" href="./css/fontawesome.min.css">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jquery-ui.min.js"></script>
    <link href="./css/bootstrap-datepicker.min.css" rel="stylesheet">
    <script src="./js/bootstrap-datepicker-v1.js"></script>
    <link rel="stylesheet" href="./css/style.css">
    <style>
        .btn-eval-period { background-color: #002e6d; border-color: #002e6d; color: #fff; }
        .btn-eval-period:hover { background-color: #004080; border-color: #004080; color: #fff; }
        /* 設定評鑑週期 Modal 內按鈕深藍色系 */
        #evalPeriodModal .modal-footer .btn-primary { background-color: #002e6d; border-color: #002e6d; color: #fff; }
        #evalPeriodModal .modal-footer .btn-primary:hover { background-color: #004080; border-color: #004080; color: #fff; }
        #evalPeriodModal .modal-footer .btn-secondary { background-color: transparent; border-color: #002e6d; color: #002e6d; }
        #evalPeriodModal .modal-footer .btn-secondary:hover { background-color: #002e6d; border-color: #002e6d; color: #fff; }
    </style>

</head>
<body id="top" class="page focus tw-min-h-screen">
    <header class="header-main">
        <nav class="navbar navbar-expand-lg navbar-light navbar-main py-lg-0">
            <div class="container-fluid flex-wrap">
                <a class="navbar-brand" href="#">
                    <img src="./images/logo.svg" alt="LOGO" class="d-none d-lg-flex flex-fill">
                    <span class="d-lg-none">國家教育研究院</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse flex-lg-wrap col-lg-12" id="navbarSupportedContent">
                    <div class="navbar-nav navbar-light navbar-dropdown navbar-primaryNav">
                        <div class="nav-item"><a class="nav-link" href="resume_view.html">研究人員履歷資料維護</a></div>
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">學術資料建檔</a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="my_academic_data.html">我的學術資料查詢</a><div class="dropdown-divider"></div><a class="dropdown-item" href="research_project_step1.html">研究計畫建檔</a>
<a class="dropdown-item" href="work_plan_step1.html">工作計畫建檔</a>
<a class="dropdown-item" href="journal_step1.html">期刊論文建檔</a>
<a class="dropdown-item" href="conference_step1.html">會議論文建檔</a>
<a class="dropdown-item" href="book_step1.html">專書建檔</a>
<a class="dropdown-item" href="chapter_step1.html">專章建檔</a>
<a class="dropdown-item" href="summary_step1.html">提要/建言/訊息建檔</a>

                            </div>
                        </div>
                        <div class="nav-item"><a class="nav-link" href="#">系統操作說明</a></div>
                        <div class="nav-item"><a class="nav-link" href="#">帳號登入/登出</a></div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="pt-lg-3">
            <div class="lg:tw-space-y-4 container-fluid py-2">
                <div class="card card-body shadow-sm tw-border-0">
                    <div class="min_height-550">
                        
<div class="row">
    <div class="col-12">
        <h2 class="border-bottom tw-text-base sm:tw-text-2xl tw-font-bold mb-4">我的學術資料查詢</h2>
        
        <div class="mb-3 d-flex justify-content-end">
            <button type="button" class="btn btn-eval-period" id="btnEvalPeriod" onclick="openEvalPeriodModal()" aria-label="設定評鑑週期">
                設定評鑑週期
            </button>
        </div>

        <div class="bg-light p-4 rounded mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="keyword" class="form-label fw-bold">關鍵字查詢</label>
                    <input type="text" class="form-control" id="keyword" placeholder="請輸入題名或關鍵字">
                </div>
                <div class="col-md-3">
                    <label for="dataType" class="form-label fw-bold">資料類型</label>
                    <select class="form-select" id="dataType">
                        <option value="All">全部</option>
                        <option value="研究計畫">研究計畫</option>
                        <option value="工作計畫">工作計畫</option>
                        <option value="期刊論文">期刊論文</option>
                        <option value="專書">專書</option>
                        <option value="專章">專章</option>
                        <option value="研討會論文">研討會論文</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="searchData()">查詢</button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle border">
                <thead class="table-dark">
                    <tr>
                        <th scope="col" width="5%">#</th>
                        <th scope="col" width="15%">資料類型</th>
                        <th scope="col">題名</th>
                        <th scope="col" width="10%" class="text-center">評鑑件數</th>
                        <th scope="col" width="15%" class="text-center">功能</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>

        <div class="pagination-container" id="pagination">
            <button class="page-btn" onclick="changePage('first')" title="最前頁">&lt;&lt;</button>
            <button class="page-btn" onclick="changePage('prev')" title="上一頁">&lt;</button>
            <span class="page-info" id="pageInfo">第 1 頁 / 共 1 頁</span>
            <button class="page-btn" onclick="changePage('next')" title="下一頁">&gt;</button>
            <button class="page-btn" onclick="changePage('last')" title="最末頁">&gt;&gt;</button>
        </div>
    </div>
</div>
    </div>
</div>

                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 設定評鑑週期 Modal（放在 body 下層以確保可正常彈出） -->
    <div class="modal fade" id="evalPeriodModal" tabindex="-1" aria-labelledby="evalPeriodModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="evalPeriodModalLabel">設定評鑑週期</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss="modal" onclick="closeEvalPeriodModal()" aria-label="關閉"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="evalPeriodStart" class="form-label">評鑑週期(起)</label>
                        <input type="text" class="form-control form_date" id="evalPeriodStart" placeholder="請選擇日期" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="evalPeriodEnd" class="form-label">評鑑週期(訖)</label>
                        <input type="text" class="form-control form_date" id="evalPeriodEnd" placeholder="請選擇日期" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-dismiss="modal" onclick="closeEvalPeriodModal()">取消</button>
                    <button type="button" class="btn btn-primary" id="evalPeriodConfirm">確定</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer py-3">
        <div class="container-fluid pt-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="small mb-0">國家教育研究院著作權所有 Copyright © 2024 All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="./js/bootstrap.bundle.min.js"></script>
    
<script>
    function initDatePicker() {
        $(".form_date").datepicker({
            language: "zh-TW",
            format: "yyyy/mm/dd",
            autoclose: true,
            orientation: "bottom auto"
        });
    }

    function openEvalPeriodModal() {
        var modalElement = document.getElementById('evalPeriodModal');
        if (!modalElement) return;
        try {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                var modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();
            } else if (typeof $ !== 'undefined' && $.fn.modal) {
                $(modalElement).modal('show');
            } else {
                $(modalElement).addClass('show').css('display', 'block');
                $('body').addClass('modal-open').append('<div class="modal-backdrop fade show" onclick="closeEvalPeriodModal()"></div>');
            }
        } catch (e) {
            $(modalElement).addClass('show').css('display', 'block');
            $('body').addClass('modal-open').append('<div class="modal-backdrop fade show" onclick="closeEvalPeriodModal()"></div>');
        }
    }

    function closeEvalPeriodModal() {
        var modalElement = document.getElementById('evalPeriodModal');
        if (!modalElement) return;
        try {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                var modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
                else bootstrap.Modal.getOrCreateInstance(modalElement).hide();
            } else if (typeof $ !== 'undefined' && $.fn.modal) {
                $(modalElement).modal('hide');
            } else {
                $(modalElement).removeClass('show').css('display', 'none');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            }
        } catch (e) {
            $(modalElement).removeClass('show').css('display', 'none');
            $('body').removeClass('modal-open');
            $('.modal-backdrop').remove();
        }
    }

    $(document).ready(function() {
        initDatePicker();
        renderTable();

        // Modal 顯示時重新綁定 datepicker（避免被 modal 蓋住）
        $('#evalPeriodModal').on('shown.bs.modal shown.modal', function() {
            $('#evalPeriodStart').datepicker('destroy');
            $('#evalPeriodEnd').datepicker('destroy');
            $('#evalPeriodStart').datepicker({
                language: "zh-TW",
                format: "yyyy/mm/dd",
                autoclose: true,
                orientation: "bottom auto"
            });
            $('#evalPeriodEnd').datepicker({
                language: "zh-TW",
                format: "yyyy/mm/dd",
                autoclose: true,
                orientation: "bottom auto"
            });
        });

        $('#evalPeriodConfirm').on('click', function() {
            var start = $('#evalPeriodStart').val();
            var end = $('#evalPeriodEnd').val();
            if (start && end) {
                alert('評鑑週期已設定：' + start + ' ~ ' + end);
                closeEvalPeriodModal();
            } else {
                alert('請設定評鑑週期(起)與評鑑週期(訖)。');
            }
        });
    });

    // 根據資料類型計算評鑑件數
    function getEvaluationCount(dataType) {
        if (dataType === "工作計畫" || dataType === "研究計畫") {
            // 工作計畫和研究計畫：預設為 1，可根據實際需求調整為 0.5
            return 1;
        } else if (dataType === "專書" || dataType === "專章" || dataType === "期刊論文") {
            // 專書、專章、期刊論文：評鑑件數為 0.2
            return 0.2;
        } else if (dataType === "會議論文") {
            // 研討會論文：評鑑件數為 0
            return 0;
        }
    }

    var allData = [];
    var types = ["研究計畫", "工作計畫", "期刊論文", "專書", "專章", "會議論文"];
    for (var i = 1; i <= 35; i++) {
        var t = types[i % types.length];
        allData.push({
            id: i,
            type: t,
            title: t + "測試資料標題 No." + i + " - 關於教育研究的範例數據",
            evaluationCount: getEvaluationCount(t)
        });
    }

    var currentPage = 1;
    var pageSize = 10;
    var filteredData = allData;

    $(document).ready(function() {
        renderTable();
    });

    function searchData() {
        var kw = $('#keyword').val().toLowerCase();
        var type = $('#dataType').val();
        
        filteredData = allData.filter(function(item) {
            var matchKw = item.title.toLowerCase().indexOf(kw) > -1;
            var matchType = (type === 'All' || item.type === type);
            return matchKw && matchType;
        });
        
        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        var totalPages = Math.ceil(filteredData.length / pageSize);
        if (totalPages === 0) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        
        var start = (currentPage - 1) * pageSize;
        var end = start + pageSize;
        var pageData = filteredData.slice(start, end);
        
        var html = '';
        if (pageData.length === 0) {
            html = '<tr><td colspan="5" class="text-center text-muted py-4">查無資料</td></tr>';
        } else {
            $.each(pageData, function(index, item) {
                var evalCount = item.evaluationCount !== undefined ? item.evaluationCount : getEvaluationCount(item.type);
                html += '<tr>';
                html += '<td>' + item.id + '</td>';
                html += '<td><span class="badge badge-type">' + item.type + '</span></td>';
                html += '<td>' + item.title + '</td>';
                html += '<td class="text-center">' + evalCount + '</td>';
                html += '<td class="text-center">';
                html += '<button class="btn btn-sm btn-outline-primary action-btn" onclick="editItem(' + item.id + ')">編輯</button>';
                html += '<button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteItem(' + item.id + ')">刪除</button>';
                html += '</td>';
                html += '</tr>';
            });
        }
        $('#dataTableBody').html(html);
        
        $('#pageInfo').text('第 ' + currentPage + ' 頁 / 共 ' + totalPages + ' 頁');
        
        $('.page-btn').removeClass('disabled');
        if (currentPage === 1) {
            $('.page-btn[onclick*="first"]').addClass('disabled');
            $('.page-btn[onclick*="prev"]').addClass('disabled');
        }
        if (currentPage === totalPages) {
            $('.page-btn[onclick*="next"]').addClass('disabled');
            $('.page-btn[onclick*="last"]').addClass('disabled');
        }
    }

    function changePage(action) {
        var totalPages = Math.ceil(filteredData.length / pageSize);
        if (totalPages === 0) totalPages = 1;
        
        if (action === 'first') currentPage = 1;
        else if (action === 'prev' && currentPage > 1) currentPage--;
        else if (action === 'next' && currentPage < totalPages) currentPage++;
        else if (action === 'last') currentPage = totalPages;
        
        renderTable();
    }

    function editItem(id) {
        alert('準備編輯資料 ID: ' + id + '。\n(系統將跳轉至該資料類型的編輯頁面)');
    }

    function deleteItem(id) {
        if (confirm('確定要刪除資料 ID: ' + id + ' 嗎？')) {
            allData = allData.filter(function(item) { return item.id !== id; });
            searchData(); 
            alert('資料已刪除。');
        }
    }
</script>

</body>
</html>
