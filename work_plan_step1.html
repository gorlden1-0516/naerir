<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>工作計畫 - 步驟1: 填寫詮釋資料 - 國家教育研究院學術典藏系統</title>
    <link rel="stylesheet" href="./Step3_files/bootstrap.min.css">
    <link rel="stylesheet" href="./Step3_files/tailwind.min.css">
    <link rel="stylesheet" href="./Step3_files/main.min.css">
    <link rel="stylesheet" href="./Step3_files/style.min.css">
    <link rel="stylesheet" href="./Step3_files/bootstrap-icons.css">
    <link rel="stylesheet" href="./Step3_files/fontawesome.min.css">
    <script src="./Step3_files/jquery.min.js.下載"></script>
    <script src="./Step3_files/jquery-ui.min.js.下載"></script>
    <link href="./Step3_files/bootstrap-datepicker.min.css" rel="stylesheet">
    <script src="./Step3_files/bootstrap-datepicker-v1.js.下載"></script>
    <link rel="stylesheet" href="./css/style.css">
    <style>
        /* 通用樣式 */
        .min_width-175 { min-width: 175px; text-align: right; margin-right: 10px; font-weight: 500; }
        .required-star { color: #dc3545; margin-right: 4px; font-weight: bold; }
        .form-hint { font-size: 0.85rem; color: #6c757d; display: block; margin-top: 0.25rem; }
        
        /* 表單動態欄位 */
        .dynamic-field-group { display: flex; align-items: center; width: 100%; margin-bottom: 8px; gap: 8px; }
        .dynamic-field-group .form-control, .dynamic-field-group .form-select { flex-grow: 1; }
        .dynamic-field-group .btn { flex-shrink: 0; white-space: nowrap; }
        .btn-remove-field { color: #dc3545; cursor: pointer; font-size: 1.2rem; font-weight: bold; font-family: Arial, sans-serif; display: flex; align-items: center; padding: 0 5px; flex-shrink: 0; }
        .btn-remove-field:hover { color: #a71d2a; background-color: #f8d7da; border-radius: 4px; }
        .btn-add-field { font-size: 0.9rem; padding: 4px 12px; margin-top: 5px; display: inline-block; font-weight: bold; }

        /* 左側固定選單 */
        .sticky-sidebar { position: -webkit-sticky; position: sticky; top: 100px; z-index: 100; }
        .listFormMenu { align-items: flex-start; }
        
        /* 查詢頁面樣式 */
        .pagination-container { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px; }
        .page-btn { cursor: pointer; padding: 5px 10px; border: 1px solid #dee2e6; background-color: #fff; color: #0d6efd; border-radius: 4px; }
        .page-btn:hover { background-color: #e9ecef; }
        .page-btn.disabled { color: #6c757d; pointer-events: none; background-color: #fff; border-color: #dee2e6; }
        .page-info { margin: 0 10px; font-weight: bold; }
        .action-btn { cursor: pointer; margin: 0 5px; font-size: 1.2rem; }
        .btn-edit { color: #0d6efd; }
        .btn-delete { color: #dc3545; }

        /* 條件顯示欄位 */
        .conditional-field { transition: all 0.3s ease; }

        /* 國教院單位模態框樣式 */
        .naer-unit-item { cursor: pointer; transition: background-color 0.2s ease; }
        .naer-unit-item:hover { background-color: #e9ecef; }
        .naer-unit-item:active { background-color: #dee2e6; }

        /* 國教院單位按鈕樣式 */
        .btn[onclick*="openNaerUnitModal"] {
            background-color: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
            font-weight: 500;
        }
        .btn[onclick*="openNaerUnitModal"]:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
            color: #fff;
        }
        .btn[onclick*="openNaerUnitModal"]:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.5);
        }

        /* 計畫參與人員整合欄位 */
        .project-member-group {
            display: flex; align-items: center; gap: 15px; margin-bottom: 12px;
            padding: 12px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;
        }
        .project-member-group .form-select, .project-member-group .form-control { flex: 1; }
        .project-member-group .member-role { min-width: 150px; }
        .project-member-group .member-name-zh { min-width: 180px; }
        .project-member-group .member-name-en { min-width: 200px; }
        .project-member-group .btn-primary { background-color: #0d6efd; border-color: #0d6efd; color: #fff; font-weight: 500; white-space: nowrap; }
        .project-member-group .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; color: #fff; }
        .project-member-group .btn-remove-member { color: #dc3545; cursor: pointer; font-size: 1.2rem; font-weight: bold; padding: 0 8px; min-width: 30px; text-align: center; }
        .project-member-group .btn-remove-member:hover { color: #a71d2a; background-color: #f8d7da; border-radius: 4px; }
        .project-members-container { margin-bottom: 15px; }
    </style>
</head>
<body id="top" class="page focus tw-min-h-screen">
    <header class="header-main">
        <nav class="navbar navbar-expand-lg navbar-light navbar-main py-lg-0">
            <div class="container-fluid flex-wrap">
                <a class="navbar-brand" href="#">
                    <img src="./Step3_files/logo.svg" alt="LOGO" class="d-none d-lg-flex flex-fill">
                    <span class="d-lg-none">國家教育研究院</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse flex-lg-wrap col-lg-12" id="navbarSupportedContent">
                    <div class="navbar-nav navbar-light navbar-dropdown navbar-primaryNav">
                        <div class="nav-item"><a class="nav-link" href="resume_view.html">研究人員履歷資料維護</a></div>
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">學術資料建檔</a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="my_academic_data.html">我的學術資料查詢</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="research_project_step1.html">研究計畫建檔</a>
                                <a class="dropdown-item" href="work_plan_step1.html">工作計畫建檔</a>
                                <a class="dropdown-item" href="journal_step1.html">期刊論文建檔</a>
                                <a class="dropdown-item" href="book_step1.html">專書建檔</a>
                                <a class="dropdown-item" href="chapter_step1.html">專章建檔</a>
                                <a class="dropdown-item" href="conference_step1.html">會議論文建檔</a>
<a class="dropdown-item" href="summary_step1.html">提要/建言/訊息建檔</a>
                            </div>
                        </div>
                        <div class="nav-item"><a class="nav-link" href="#">系統操作說明</a></div>
                        <div class="nav-item"><a class="nav-link" href="#">帳號登入/登出</a></div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="pt-lg-3">
            <div class="lg:tw-space-y-4 container-fluid py-2">
                <div class="card card-body shadow-sm tw-border-0">
                    <div class="min_height-550">
                        
    <div class="row row-cols-lg-auto g-lg-4">
        <div class="col-lg-9 tw-flex-1">
            <h2 class="border-bottom tw-text-base sm:tw-text-2xl tw-font-bold overflow-hidden mb-4">工作計畫 - 步驟1: 填寫詮釋資料</h2>
            <div class="listFormMenu row g-3">
                <div class="col-lg-3">
                    <div class="nav nav-pills row row-cols-auto row-cols-lg-1 g-2 flex-nowrap flex-lg-wrap overflow-auto sticky-sidebar">
                    <div class="col"><a class="nav-link active" href="javascript:void(0);">步驟1: 填寫詮釋資料</a></div>
                    <div class="col"><a class="nav-link" href="javascript:void(0);" onclick="validateAndNavigate('work_plan_step2.html')">步驟2: 上傳檔案</a></div>
                    <div class="col"><a class="nav-link disabled" href="#">步驟3: 確認並送出檢核</a></div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="tabPane bg-light p-3">
                        <div class="col-12 text-end mb-2">
                            <span class="required-star">*</span> 為必填欄位　<span style="color:#0d6efd;font-weight:bold;">*</span> 至少填寫其中一項
                        </div>
                        <div class="row g-4">

                            <!-- 計畫編號/立案公文號（單值） -->
                            <div class="col-md-6">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label"><span class="required-star">*</span>計畫編號/立案公文號</label>
                                    <div class="col">
                                        <input type="text" class="form-control required-field" id="field_d8baaedb" placeholder="" data-label="計畫編號/立案公文號">
                                        <span class="form-hint">工作計畫立案編號/立案公文文號</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 計畫名稱 -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label"><span style="color:#0d6efd;font-weight:bold;">*</span>計畫名稱</label>
                                    <div class="col">
                                        <input type="text" class="form-control plan-title-required" id="field_cfc05367" placeholder="戶外教育課程發展與實作" data-label="計畫名稱">
                                    </div>
                                </div>
                            </div>

                            <!-- 計畫名稱（外文） -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label"><span style="color:#0d6efd;font-weight:bold;">*</span>計畫名稱（外文）</label>
                                    <div class="col">
                                        <input type="text" class="form-control plan-title-required" id="field_7b53fc2c" placeholder="" data-label="計畫名稱（外文）">
                                    </div>
                                </div>
                            </div>

                            <!-- 計畫類型（非必填，選其他時右側顯示填寫欄） -->
                            <div class="col-12">
                                <div class="row g-3 align-items-start">
                                    <div class="col-md-6">
                                        <div class="row">
                                            <label class="min_width-175 col-sm-auto col-form-label">計畫類型</label>
                                            <div class="col">
                                                <select class="form-select" id="field_25bd4fa7">
                                                    <option value="">請選擇</option>
                                                    <option value="整合型計畫">整合型計畫</option>
                                                    <option value="個別型計畫">個別型計畫</option>
                                                    <option value="其它">其它</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6" id="project_type_other_field" style="display:none;">
                                        <div class="row">
                                            <label class="min_width-175 col-sm-auto col-form-label"><span class="required-star">*</span>其它（請填寫）</label>
                                            <div class="col">
                                                <input type="text" class="form-control required-field" id="project_type_other" placeholder="請填寫其它計畫類型" data-label="計畫類型（其它）">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 整合型計畫名稱（計畫類型=整合型時顯示） -->
                            <div class="col-12 conditional-field" id="integrated_project_name_zh_field" style="display:none;">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">整合型計畫名稱</label>
                                    <div class="col">
                                        <input type="text" class="form-control" id="field_214ab4b7" placeholder="戶外教育研究室系列(I)" data-label="整合型計畫名稱">
                                        <span class="form-hint"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 整合型計畫名稱（外文）（計畫類型=整合型時顯示） -->
                            <div class="col-12 conditional-field" id="integrated_project_name_en_field" style="display:none;">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">整合型計畫名稱（外文）</label>
                                    <div class="col">
                                        <input type="text" class="form-control" id="field_0f5e4295" placeholder="" data-label="整合型計畫名稱（外文）">
                                        <span class="form-hint"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 所屬計畫（計畫類型=整合型時顯示，多值，含其他條件欄位） -->
                            <div class="col-12 conditional-field" id="sub_project_field" style="display:none;">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">所屬計畫</label>
                                    <div class="col">
                                        <div class="dynamic-container">
                                            <div class="dynamic-field-group sub-project-group align-items-center">
                                                <select class="form-select sub-project-select flex-shrink-0" id="field_f003d702" style="max-width:180px;">
                                                    <option value="">請選擇</option>
                                                    <option value="總計畫">總計畫</option>
                                                    <option value="計畫一">計畫一</option>
                                                    <option value="計畫二">計畫二</option>
                                                    <option value="計畫三">計畫三</option>
                                                    <option value="計畫四">計畫四</option>
                                                    <option value="計畫五">計畫五</option>
                                                    <option value="計畫六">計畫六</option>
                                                    <option value="計畫七">計畫七</option>
                                                    <option value="計畫八">計畫八</option>
                                                    <option value="計畫九">計畫九</option>
                                                    <option value="計畫十">計畫十</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 計畫參與人員 -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">參與人員</label>
                                    <div class="col">
                                        <div class="project-members-container" id="project_members_container">
                                            <div class="project-member-group">
                                                <select class="form-select member-role">
                                                    <option value="">請選擇</option>
                                                    <option value="計畫主持人">計畫主持人</option>
                                                    <option value="共同主持人">共同主持人</option>
                                                    <option value="協同主持人">協同主持人</option>
                                                    <option value="研究員">研究員</option>
                                                    <option value="研究助理">研究助理</option>
                                                    <option value="計畫參與人員">計畫參與人員</option>
                                                </select>
                                                <input type="text" class="form-control member-name-zh" placeholder="中文姓名">
                                                <input type="text" class="form-control member-name-en" placeholder="Last Name, Middle Name, First Name">
                                                <button type="button" class="btn btn-primary btn-sm" onclick="openNaerMemberModal(this)" title="挑選本院人員">挑選本院人員</button>
                                                <span class="btn-remove-member" onclick="removeProjectMember(this)" title="刪除">X</span>
                                            </div>
                                            <div class="project-member-group">
                                                <select class="form-select member-role">
                                                    <option value="">請選擇</option>
                                                    <option value="計畫主持人">計畫主持人</option>
                                                    <option value="共同主持人">共同主持人</option>
                                                    <option value="協同主持人">協同主持人</option>
                                                    <option value="研究員">研究員</option>
                                                    <option value="研究助理">研究助理</option>
                                                    <option value="計畫參與人員">計畫參與人員</option>
                                                </select>
                                                <input type="text" class="form-control member-name-zh" placeholder="中文姓名">
                                                <input type="text" class="form-control member-name-en" placeholder="Last Name, Middle Name, First Name">
                                                <button type="button" class="btn btn-primary btn-sm" onclick="openNaerMemberModal(this)" title="挑選本院人員">挑選本院人員</button>
                                                <span class="btn-remove-member" onclick="removeProjectMember(this)" title="刪除">X</span>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-add-field" onclick="addProjectMember()">+ 新增參與人員</button>
                                        <span class="form-hint">可新增多組參與人員資料</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 經費來源（必填，多值） -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label"><span class="required-star">*</span>經費來源</label>
                                    <div class="col">
                                        <div class="dynamic-container">
                                            <div class="dynamic-field-group">
                                                <input type="text" class="form-control required-field" id="field_c7e38d7e" placeholder="國家教育研究院" data-label="經費來源">
                                                <span class="btn-remove-field" onclick="removeField(this)" title="刪除">X</span>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-add-field" onclick="addField(this)">+ 新增</button>
                                        <span class="form-hint">可新增多個經費來源</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 執行方式（必填，單獨一列，選其它時顯示填寫欄） -->
                            <div class="col-12">
                                <div class="row align-items-center g-3">
                                    <div class="col-md-6">
                                        <div class="row">
                                            <label class="min_width-175 col-sm-auto col-form-label"><span class="required-star">*</span>執行方式</label>
                                            <div class="col">
                                                <select class="form-select required-field" id="field_8508cebf" data-label="執行方式" onchange="handleExecMethodChange()">
                                                    <option value="">請選擇</option>
                                                    <option value="自行研究">自行研究</option>
                                                    <option value="合作研究">合作研究</option>
                                                    <option value="共同研究">共同研究</option>
                                                    <option value="委託研究">委託研究</option>
                                                    <option value="補助">補助</option>
                                                    <option value="委辦">委辦</option>
                                                    <option value="學術補助">學術補助</option>
                                                    <option value="其它">其它</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 conditional-field" id="exec_method_other_col" style="display:none;">
                                        <div class="row">
                                            <label class="min_width-175 col-sm-auto col-form-label"><span class="required-star">*</span>其它（請填寫）</label>
                                            <div class="col">
                                                <input type="text" class="form-control required-field" id="field_exec_method_other" placeholder="請填寫其他執行方式" data-label="執行方式（其它）">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 執行機構 / 執行單位（成對動態容器） -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">執行機構 /<br>執行單位</label>
                                    <div class="col">
                                        <div class="d-flex gap-2 mb-1" style="font-size:0.82rem;color:#6c757d;">
                                            <span style="flex:1;">執行機構</span>
                                            <span style="flex:1;">執行單位</span>
                                            <span style="width:88px;"></span>
                                        </div>
                                        <div class="dynamic-container" id="execution_inst_unit_container">
                                            <div class="dynamic-field-group execution-inst-unit-pair">
                                                <input type="text" class="form-control execution-inst-input" id="field_db4fbc5f" placeholder="如：國家教育研究院" style="flex:1;">
                                                <input type="text" class="form-control execution-unit-input" id="field_dbd12002" placeholder="如：教科書發展中心" style="flex:1;">
                                                <button type="button" class="btn btn-primary btn-sm" onclick="openNaerUnitModal(this)" title="選擇國教院單位" style="white-space:nowrap;">國教院單位</button>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-add-field" onclick="addExecutionPair()">+ 新增</button>
                                        <span class="form-hint">可新增多組；選擇國教院單位時將自動填入同列執行機構</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 年度 -->
                            <div class="col-md-6">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label"><span class="required-star">*</span>年度</label>
                                    <div class="col">
                                        <input type="text" class="form-control required-field" id="field_9dfd1938" placeholder="2017" data-label="年度">
                                        <span class="form-hint">西元年 YYYY</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 執行期程（起）/（訖）同一列 -->
                            <div class="col-12">
                                <div class="row g-3 align-items-start">
                                    <div class="col-md-6">
                                        <div class="row">
                                            <label class="min_width-175 col-sm-auto col-form-label">執行期程(起)</label>
                                            <div class="col">
                                                <input type="text" class="form-control form_date" id="field_2d0a2977" placeholder="YYYY/MM/DD">
                                                <span class="form-hint">YYYY/MM/DD</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <label class="min_width-175 col-sm-auto col-form-label">執行期程(訖)</label>
                                            <div class="col">
                                                <input type="text" class="form-control form_date" id="field_8d959930" placeholder="YYYY/MM/DD">
                                                <span class="form-hint">YYYY/MM/DD</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 執行狀態 -->
                            <div class="col-md-6">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">執行狀態</label>
                                    <div class="col">
                                        <select class="form-select" id="field_23c911db">
                                            <option value="">請選擇</option>
                                            <option value="執行中">執行中</option>
                                            <option value="已結案">已結案</option>
                                            <option value="已撤案">已撤案</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- 計畫經費（僅限數字） -->
                            <div class="col-md-6">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">計畫經費</label>
                                    <div class="col">
                                        <input type="text" class="form-control num-only" id="field_fe5395ae" placeholder="請填寫數字金額">
                                        <span class="form-hint">僅限數字</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 摘要（移至關鍵詞前） -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">摘要</label>
                                    <div class="col">
                                        <textarea class="form-control" id="field_3ae14696" rows="5" placeholder=""></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- 摘要（外文）（移至關鍵詞前） -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">摘要（外文）</label>
                                    <div class="col">
                                        <textarea class="form-control" id="field_e353dbe4" rows="5" placeholder=""></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- 關鍵詞 -->
                            <div class="col-md-6">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">關鍵詞</label>
                                    <div class="col">
                                        <div class="dynamic-container">
                                            <div class="dynamic-field-group">
                                                <input type="text" class="form-control" id="field_eac6edef" placeholder="">
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-add-field" onclick="addField(this)">+ 新增</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 關鍵詞（外文） -->
                            <div class="col-md-6">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">關鍵詞（外文）</label>
                                    <div class="col">
                                        <div class="dynamic-container">
                                            <div class="dynamic-field-group">
                                                <input type="text" class="form-control" id="field_af607fda" placeholder="">
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-add-field" onclick="addField(this)">+ 新增</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 相關連結 -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">相關連結</label>
                                    <div class="col">
                                        <div class="dynamic-container">
                                            <div class="dynamic-field-group">
                                                <input type="text" class="form-control me-2" id="field_445a9609_name" placeholder="網站名稱（如：GRB 政府研究資訊網）" style="flex: 1;">
                                                <input type="text" class="form-control" id="field_445a9609" placeholder="https://..." style="flex: 2;">
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-add-field" onclick="addField(this)">+ 新增</button>
                                        <span class="form-hint">第一欄填網站名稱，第二欄填網址，可新增多組</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 備註 -->
                            <div class="col-12">
                                <div class="row">
                                    <label class="min_width-175 col-sm-auto col-form-label">備註 (文字)</label>
                                    <div class="col">
                                        <textarea class="form-control" id="field_d11d59c6" rows="5" placeholder="1.報告名稱變更..."></textarea>
                                        <span class="form-hint">前端（臺）不顯示此欄位內容，只做建檔備註使用</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="tabPane bg-light p-3 mt-3">
                        <div class="row">
                            <div class="col"><a class="btn_grey-light btn btn-light w-100 disabled" href="#">回上一頁</a></div>
                            <div class="col"><a class="btn_primary btn btn-primary w-100" href="javascript:void(0);" onclick="validateAndNavigate('work_plan_step2.html')">下一步</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer py-3">
        <div class="container-fluid pt-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="small mb-0">國家教育研究院著作權聲明 Copyright © 2024 All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="./Step3_files/bootstrap.bundle.min.js"></script>
    
<script>
    $(document).ready(function(){
        initDatePicker();
        updateRemoveButtons();

        // 計畫名稱群組：有任一欄輸入時清除紅框
        $(document).on('input', '.plan-title-required', function() {
            if ($.trim($('#field_cfc05367').val()) !== '' || $.trim($('#field_7b53fc2c').val()) !== '') {
                $('#field_cfc05367, #field_7b53fc2c').removeClass('is-invalid');
            }
        });

        // 計畫類型聯動：整合型顯示名稱+所屬計畫，其它顯示填寫欄
        $('#field_25bd4fa7').on('change', function() {
            var value = $(this).val();
            if (value === '整合型計畫') {
                $('#integrated_project_name_zh_field').show();
                $('#integrated_project_name_en_field').show();
                $('#sub_project_field').show();
                $('#project_type_other_field').hide();
                $('#project_type_other').val('');
            } else if (value === '其它') {
                $('#integrated_project_name_zh_field').hide();
                $('#integrated_project_name_en_field').hide();
                $('#sub_project_field').hide();
                $('#field_214ab4b7, #field_0f5e4295').val('').removeClass('is-invalid');
                $('#project_type_other_field').show();
            } else {
                $('#integrated_project_name_zh_field').hide();
                $('#integrated_project_name_en_field').hide();
                $('#sub_project_field').hide();
                $('#field_214ab4b7, #field_0f5e4295').val('').removeClass('is-invalid');
                $('#project_type_other_field').hide();
                $('#project_type_other').val('');
            }
        });

        // 所屬計畫「其他」：同列右側顯示欄位名稱與輸入框
        $(document).on('change', '.sub-project-select', function() {
            var group = $(this).closest('.sub-project-group');
            if ($(this).val() === '其他') {
                group.find('.sub-project-other-label').show();
                group.find('.sub-project-other').show();
            } else {
                group.find('.sub-project-other-label').hide();
                group.find('.sub-project-other').hide().val('');
            }
        });

        // 計畫經費：只允許數字
        $(document).on('keydown', '.num-only', function(e) {
            var allowedKeys = ['Backspace','Delete','Tab','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End'];
            if (allowedKeys.indexOf(e.key) !== -1) return;
            if ((e.key === 'a' || e.key === 'c' || e.key === 'v') && (e.ctrlKey || e.metaKey)) return;
            if (!/^\d$/.test(e.key)) e.preventDefault();
        });
        $(document).on('input', '.num-only', function() {
            $(this).val($(this).val().replace(/[^\d]/g, ''));
        });

        // 挑選本院人員模態框關閉時清空引用
        $('#naerMemberModal').on('hidden.bs.modal hidden.modal', function () {
            currentMemberNameZhInput = null;
            currentMemberNameEnInput = null;
            $('.modal-backdrop').remove();
        });
        // 國教院單位模態框關閉時清空引用
        $('#naerUnitModal').on('hidden.bs.modal hidden.modal', function () {
            currentExecutionUnitInput = null;
            $('.modal-backdrop').remove();
        });
    });

    function initDatePicker() {
        $(".form_date").datepicker({ language: "zh-TW", format: "yyyy/mm/dd", autoclose: true, orientation: "bottom auto" });
    }

    function validateAndNavigate(url) {
        var isValid = true;

        // 群組1：計畫名稱 或 計畫名稱（外文）至少填一
        var planTitleZh = $.trim($('#field_cfc05367').val());
        var planTitleEn = $.trim($('#field_7b53fc2c').val());
        if (planTitleZh === '' && planTitleEn === '') {
            alert('請至少填寫【計畫名稱】或【計畫名稱（外文）】其中一項');
            $('#field_cfc05367').addClass('is-invalid')[0].scrollIntoView({behavior:'smooth',block:'center'});
            $('#field_7b53fc2c').addClass('is-invalid');
            $('#field_cfc05367').focus(); isValid = false;
        } else { $('#field_cfc05367, #field_7b53fc2c').removeClass('is-invalid'); }


        // 一般必填欄位（僅可見欄位）
        if (isValid) {
            $('.required-field:visible').each(function() {
            if ($.trim($(this).val()) === '') {
                    var labelName = $(this).attr('data-label') || $(this).closest('.row').find('label').text().replace('*', '').trim() || '必填欄位';
                alert('請填寫 [' + labelName + ']');
                this.scrollIntoView({behavior: "smooth", block: "center"});
                $(this).focus();
                isValid = false; return false;
            }
        });
        }
        if (isValid) {
            var memberNameError = null;
            $('#project_members_container .project-member-group').each(function() {
                var role = $.trim($(this).find('.member-role').val());
                var nameZh = $.trim($(this).find('.member-name-zh').val());
                var nameEn = $.trim($(this).find('.member-name-en').val());
                if (role !== '' && nameZh === '' && nameEn === '') {
                    memberNameError = this;
                    return false;
                }
            });
            if (memberNameError) {
                alert('選擇參與人員職稱後，至少須填寫【中文姓名】或【English Name】其中一項');
                memberNameError.scrollIntoView({behavior: 'smooth', block: 'center'});
                $(memberNameError).find('.member-name-zh').focus();
                isValid = false;
            }
        }
        if (isValid) {
            if (url && url !== '#') window.location.href = url;
            else if (url === '#') alert('資料檢查無誤，準備送出！');
        }
        return false;
    }

    function handleExecMethodChange() {
        var val = $('#field_8508cebf').val();
        if (val === '其它') {
            $('#exec_method_other_col').show();
        } else {
            $('#exec_method_other_col').hide();
            $('#field_exec_method_other').val('');
        }
    }

    function addField(btn) {
        var container = $(btn).siblings('.dynamic-container');
        var newGroup = container.find('.dynamic-field-group').first().clone();
        newGroup.find('input, select, textarea').val('');
        newGroup.find('*').removeAttr('id');

        // 所屬計畫：克隆時隱藏其他(請填寫)欄位
        var isSubProjectField = container.find('.sub-project-select').length > 0;
        if (isSubProjectField) {
            newGroup.find('.sub-project-select').val('');
            newGroup.find('.sub-project-other-label').hide();
            newGroup.find('.sub-project-other').hide().val('');
        }

        if (newGroup.find('.btn-remove-field').length === 0) {
            newGroup.append('<span class="btn-remove-field" onclick="removeField(this)" title="刪除">X</span>');
        }
        container.append(newGroup);
        initDatePicker();
    }

    function removeField(btn) { $(btn).closest('.dynamic-field-group').remove(); }

    // 新增執行機構/執行單位配對列
    function addExecutionPair() {
        var container = $('#execution_inst_unit_container');
        var firstPair = container.find('.execution-inst-unit-pair').first();
        var newPair = firstPair.clone();
        newPair.find('input').val('').removeAttr('id');
        if (newPair.find('.btn-remove-field').length === 0) {
            newPair.append('<span class="btn-remove-field" onclick="removeExecutionPair(this)" title="刪除">X</span>');
        }
        container.append(newPair);
    }

    function removeExecutionPair(btn) {
        var container = $('#execution_inst_unit_container');
        if (container.find('.execution-inst-unit-pair').length > 1) {
            $(btn).closest('.execution-inst-unit-pair').remove();
        } else {
            alert('至少需要保留一組執行機構/執行單位資料');
        }
    }

    // 新增計畫參與人員
    function addProjectMember() {
        var container = $('#project_members_container');
        var firstGroup = container.find('.project-member-group').first();
        var newGroup = firstGroup.clone();
        newGroup.find('select').val('');
        newGroup.find('input').val('');
        if (newGroup.find('button[onclick*="openNaerMemberModal"]').length === 0) {
            newGroup.find('.member-name-en').after('<button type="button" class="btn btn-primary btn-sm" onclick="openNaerMemberModal(this)" title="挑選本院人員">挑選本院人員</button>');
        }
        if (newGroup.find('.btn-remove-member').length === 0) {
            newGroup.append('<span class="btn-remove-member" onclick="removeProjectMember(this)" title="刪除">X</span>');
        }
        container.append(newGroup);
        updateRemoveButtons();
    }

    function removeProjectMember(btn) {
        var container = $('#project_members_container');
        if (container.find('.project-member-group').length > 1) {
            $(btn).closest('.project-member-group').remove();
            updateRemoveButtons();
        } else {
            alert('至少需要保留一組參與人員資料');
        }
    }

    function updateRemoveButtons() {
        var container = $('#project_members_container');
        var groups = container.find('.project-member-group');
        if (groups.length <= 1) groups.find('.btn-remove-member').hide();
        else groups.find('.btn-remove-member').show();
    }
</script>

<!-- 國教院單位選擇模態框 -->
<div class="modal fade" id="naerUnitModal" tabindex="-1" aria-labelledby="naerUnitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="naerUnitModalLabel">選擇國教院單位</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <button type="button" class="list-group-item list-group-item-action naer-unit-item" data-unit="教育制度及政策研究中心">教育制度及政策研究中心</button>
                    <button type="button" class="list-group-item list-group-item-action naer-unit-item" data-unit="課程及教學研究中心">課程及教學研究中心</button>
                    <button type="button" class="list-group-item list-group-item-action naer-unit-item" data-unit="測驗及評量研究中心">測驗及評量研究中心</button>
                    <button type="button" class="list-group-item list-group-item-action naer-unit-item" data-unit="語文教育及編譯研究中心">語文教育及編譯研究中心</button>
                    <button type="button" class="list-group-item list-group-item-action naer-unit-item" data-unit="教科書研究中心">教科書研究中心</button>
                    <button type="button" class="list-group-item list-group-item-action naer-unit-item" data-unit="原住民族教育研究中心">原住民族教育研究中心</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- 挑選本院人員模態框 -->
<div class="modal fade" id="naerMemberModal" tabindex="-1" aria-labelledby="naerMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="naerMemberModalLabel">挑選本院人員</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                <div id="naer_member_list"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<script>
    var currentMemberNameZhInput = null;
    var currentMemberNameEnInput = null;
    var currentExecutionUnitInput = null;

    var naerMembers = {
        '教育制度及政策研究中心': [
            { nameZh: '陳建宏', nameEn: 'Chen, Chien-Hung' },
            { nameZh: '林美玲', nameEn: 'Lin, Mei-Ling' },
            { nameZh: '張志明', nameEn: 'Chang, Chih-Ming' },
            { nameZh: '王淑芬', nameEn: 'Wang, Shu-Fen' },
            { nameZh: '黃文傑', nameEn: 'Huang, Wen-Chieh' }
        ],
        '課程及教學研究中心': [
            { nameZh: '李雅婷', nameEn: 'Lee, Ya-Ting' },
            { nameZh: '吳志強', nameEn: 'Wu, Chih-Chiang' },
            { nameZh: '劉佳宜', nameEn: 'Liu, Chia-Yi' },
            { nameZh: '鄭文華', nameEn: 'Cheng, Wen-Hua' },
            { nameZh: '許淑娟', nameEn: 'Hsu, Shu-Chuan' }
        ],
        '測驗及評量研究中心': [
            { nameZh: '楊智勝', nameEn: 'Yang, Chih-Sheng' },
            { nameZh: '謝佳蓉', nameEn: 'Hsieh, Chia-Jung' },
            { nameZh: '蔡明哲', nameEn: 'Tsai, Ming-Che' },
            { nameZh: '周雅芳', nameEn: 'Chou, Ya-Fang' },
            { nameZh: '羅建宏', nameEn: 'Lo, Chien-Hung' }
        ],
        '語文教育及編譯研究中心': [
            { nameZh: '徐美惠', nameEn: 'Hsu, Mei-Hui' },
            { nameZh: '曾文彬', nameEn: 'Tseng, Wen-Pin' },
            { nameZh: '蘇雅雯', nameEn: 'Su, Ya-Wen' },
            { nameZh: '江志偉', nameEn: 'Chiang, Chih-Wei' },
            { nameZh: '葉淑芬', nameEn: 'Yeh, Shu-Fen' }
        ],
        '教科書研究中心': [
            { nameZh: '何建明', nameEn: 'Ho, Chien-Ming' },
            { nameZh: '沈雅玲', nameEn: 'Shen, Ya-Ling' },
            { nameZh: '馬文傑', nameEn: 'Ma, Wen-Chieh' },
            { nameZh: '高淑華', nameEn: 'Kao, Shu-Hua' },
            { nameZh: '趙志強', nameEn: 'Chao, Chih-Chiang' }
        ],
        '原住民族教育研究中心': [
            { nameZh: '孫美玲', nameEn: 'Sun, Mei-Ling' },
            { nameZh: '鍾文華', nameEn: 'Chung, Wen-Hua' },
            { nameZh: '盧雅芳', nameEn: 'Lu, Ya-Fang' },
            { nameZh: '魏建宏', nameEn: 'Wei, Chien-Hung' },
            { nameZh: '韓淑娟', nameEn: 'Han, Shu-Chuan' }
        ]
    };

    function openNaerMemberModal(btn) {
        var memberGroup = $(btn).closest('.project-member-group');
        currentMemberNameZhInput = memberGroup.find('.member-name-zh');
        currentMemberNameEnInput = memberGroup.find('.member-name-en');
        generateMemberList();
        var modalElement = document.getElementById('naerMemberModal');
        if (modalElement) {
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    bootstrap.Modal.getOrCreateInstance(modalElement).show();
                } else if (typeof $ !== 'undefined' && $.fn.modal) {
                    $(modalElement).modal('show');
                } else {
                    $(modalElement).addClass('show').css('display', 'block');
                    $('body').append('<div class="modal-backdrop fade show"></div>');
                }
            } catch (e) {
                $(modalElement).addClass('show').css('display', 'block');
                $('body').append('<div class="modal-backdrop fade show"></div>');
            }
        }
    }

    function generateMemberList() {
        var html = '';
        Object.keys(naerMembers).forEach(function(unit) {
            html += '<div class="mb-4"><h6 class="fw-bold text-primary mb-2 border-bottom pb-2">' + unit + '</h6><div class="list-group">';
            naerMembers[unit].forEach(function(member) {
                html += '<button type="button" class="list-group-item list-group-item-action naer-member-item" data-name-zh="' + member.nameZh + '" data-name-en="' + member.nameEn + '">';
                html += '<div class="d-flex justify-content-between align-items-center"><span><strong>' + member.nameZh + '</strong></span><small class="text-muted">' + member.nameEn + '</small></div></button>';
            });
            html += '</div></div>';
        });
        $('#naer_member_list').html(html);
    }

    $(document).on('click', '.naer-member-item', function() {
        var nameZh = $(this).data('name-zh');
        var nameEn = $(this).data('name-en');
        var currentGroup = currentMemberNameZhInput ? currentMemberNameZhInput.closest('.project-member-group') : null;
        var container = currentGroup ? currentGroup.closest('.project-members-container') : null;
        if (container && container.length) {
            var isDuplicate = false;
            container.find('.project-member-group').each(function() {
                if (this !== currentGroup[0]) {
                    var zh = $.trim($(this).find('.member-name-zh').val());
                    var en = $.trim($(this).find('.member-name-en').val());
                    if ((zh === nameZh && zh !== '') || (en === nameEn && en !== '')) { isDuplicate = true; return false; }
                }
            });
            if (isDuplicate) {
                alert('該人員已在參與人員名單中，請勿重複選擇');
                return;
            }
        }
        if (currentMemberNameZhInput) currentMemberNameZhInput.val(nameZh);
        if (currentMemberNameEnInput) currentMemberNameEnInput.val(nameEn);
        var modalElement = document.getElementById('naerMemberModal');
        if (modalElement) {
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    var modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide(); else bootstrap.Modal.getOrCreateInstance(modalElement).hide();
                } else if (typeof $ !== 'undefined' && $.fn.modal) {
                    $(modalElement).modal('hide');
                } else {
                    $(modalElement).removeClass('show').css('display', 'none');
                    $('.modal-backdrop').remove();
                }
            } catch (e) {
                $(modalElement).removeClass('show').css('display', 'none');
                $('.modal-backdrop').remove();
            }
        }
        currentMemberNameZhInput = null;
        currentMemberNameEnInput = null;
    });

    function openNaerUnitModal(btn) {
        currentExecutionUnitInput = $(btn).siblings('.execution-unit-input');
        var modalElement = document.getElementById('naerUnitModal');
        if (modalElement) {
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    bootstrap.Modal.getOrCreateInstance(modalElement).show();
                } else if (typeof $ !== 'undefined' && $.fn.modal) {
                    $(modalElement).modal('show');
                } else {
                    $(modalElement).addClass('show').css('display', 'block');
                    $('body').append('<div class="modal-backdrop fade show"></div>');
                }
            } catch (e) {
                $(modalElement).addClass('show').css('display', 'block');
                $('body').append('<div class="modal-backdrop fade show"></div>');
            }
        }
    }

    $(document).on('click', '.naer-unit-item', function() {
        var selectedUnit = $(this).data('unit');
        if (currentExecutionUnitInput && currentExecutionUnitInput.length > 0) {
            currentExecutionUnitInput.val(selectedUnit);
            // 自動填入同列的執行機構
            var $pairRow = currentExecutionUnitInput.closest('.execution-inst-unit-pair');
            if ($pairRow.length > 0) {
                $pairRow.find('.execution-inst-input').val('國家教育研究院');
            }
        }
        var modalElement = document.getElementById('naerUnitModal');
        if (modalElement) {
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    var modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide(); else bootstrap.Modal.getOrCreateInstance(modalElement).hide();
                } else if (typeof $ !== 'undefined' && $.fn.modal) {
                    $(modalElement).modal('hide');
                } else {
                    $(modalElement).removeClass('show').css('display', 'none');
                    $('.modal-backdrop').remove();
                }
            } catch (e) {
                $(modalElement).removeClass('show').css('display', 'none');
                $('.modal-backdrop').remove();
            }
        }
        currentExecutionUnitInput = null;
    });
</script>

</body>
</html>
